{% extends "ideas/base.html" %}
{% load static %}
{% block head %}
<script>
$(document).ready(function(){
  var idea_id = {{ title.id }}

  var url = "/ideas/view/subs/"+idea_id
    $.ajax({
      type: "GET",
      url: url,
      success: function(data)
      {
        
        $.each(data, function(index, val) {
          var url = "/ideas/view/is_parent/"+val.id
          $.ajax({
            type: "GET",
            url: url,
            success: function(subs)
            {
              if ( subs > 0 ) {
                if ( val.drop_type === 'spark'){
                  $('ul#spark_list').append("<li id='"+val.id+"'><a href='/ideas/view/"+val.id+"'>"+val.data+"</a></li>")
                } else if ( val.drop_type === 'idea') {
                  $('ul#idea_list').append("<li id='"+val.id+"'><a href='/ideas/view/"+val.id+"' class='parent'>"+val.data+"</a></li>")
                } else if ( val.drop_type === 'action') {
                  $('ul#spark_list').append("<li id='"+val.id+"'><a href='/ideas/view/"+val.id+"' class='parent'>"+val.data+"</a></li>")
                }
              } else {
                if ( val.drop_type === 'spark'){
                  $('ul#spark_list').append("<li id='"+val.id+"'>"+val.data+"</li>")
                } else if ( val.drop_type === 'idea') {
                  $('ul#idea_list').append("<li id='"+val.id+"'>"+val.data+"</li>")
                } else if ( val.drop_type === 'action') {
                  $('ul#spark_list').append("<li id='"+val.id+"'>"+val.data+"</li>")
                }
              }
            }
          })

        })
      }
    })
 
 });   
</script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>



{% endblock %}

{% block main %}
<div class="container-fluid">

<div class="row" id="main" style="margin-top: 20px;">
 <div class="col-md-3 col-md-offset-1">
  <ul class="list-unstyled">
    <li><h2>{{ title | title }}</h2></li>
    <li>Date submitted: {{ title.date|date }}</li>
    <li>Views: {{ title.views }}</li>
    <li>Replies: {{ children }}</li>
  </ul>
 </div>
 <div class="col-md-5" id="svg" style="min-height: 250px; background: #e5e5e5; margin-bottom: 20px">
 </div>
</div>
<script type="text/javascript">
    
    var width = $("#svg").width(),
        height = $("#svg").height();
    
    var color = d3.scale.category20();
    
    var force = d3.layout.force()
        .gravity(.05)
        .charge(-100)
        .linkDistance(20)
        .size([width, height]);
    
    var svg = d3.select("#svg").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("pointer-events", "all");
    if ( {{ title.origin_id }} == 0 ){
      drop_id = {{ title.id }}
    } else {
      drop_id = {{ title.origin_id }}
    }
    d3.json("/ideas/view/map/"+drop_id, function( error, json) {
      console.log(json);
      var edges = [];
         json.links.forEach(function(e){
          var sourceNode = json.nodes.filter(function(n) { return n.id === e.source; })[0],
          targetNode = json.nodes.filter(function(n) { return n.id === e.target; })[0];
          
          edges.push({source: sourceNode, target: targetNode, value: e.value});
          
         })
         
      force
          .nodes(json.nodes)
          .links(edges)
          .start();
    
      var link = svg.selectAll("line.link")
          .data(edges)
        .enter().append("line")
          .attr("class", "link")
          /*.style("stroke-width", function(d) { return Math.sqrt(d.value); });*/
          .style("stroke-width", "1px");
    
      var node = svg.selectAll("circle.node")
          .data(json.nodes)
        .enter().append("circle")
          .attr("class", "node")
          .attr("r", function(d){return d.weight+5;})
          .style("fill", function(d) { // return color(d.group); })
            if(d.id ==={{title.id }}) return "#ff0000";
            if(d.drop_type==='idea') return "#fefeb5";
            if(d.drop_type==='spark') return "#fed3d3";
            if(d.drop_type==='action') return "#babafe";
            
          })
          .on("click", function(d){
            // console.log(d)
            // $location.search(d,d.id);
            window.location.href="/ideas/view/" + d.id ;
            
          })
          .call(force.drag);


      node.append("title")
          .text(function(d) { return d.name; });
      node.attr("id", function(d) { return d.id;});
    
      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });
    
        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
      });
    });
    
 </script>

<div class="row">
 <div class="col-md-8 col-md-offset-1">

  <div class="row" style="min-height: 250px">

    <div class="col-md-4">
     <div class="spark alert"><center><h4>Sparks</h4></center></div>
     <ul id="spark_list" class="list-unstyled">

     </ul>
    </div>

    <div class="col-md-4">
     <div class="idea alert" id="title"><center><h4>Ideas</h4></center></div>
      <ul id="idea_list" class="list-unstyled">

      </ul>
    </div>

    <div class="col-md-4">
     <div class="action alert"><center><h4 class="">Actions</h4></center></div>
     <ul id="action_list" class="list-unstyled">

      </ul>
    </div>

  </div><!-- row -->
 </div><!-- column -->
</div><!-- row -->


<div class="row">
  <div class="col-md-8 col-md-offset-3">
    <div id="data">
    </div>  
  </div>
</div>

</div><!-- container -->


{% endblock %}
